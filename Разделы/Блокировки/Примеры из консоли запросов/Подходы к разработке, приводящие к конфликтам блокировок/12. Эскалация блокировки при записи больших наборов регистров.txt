Запрос = Новый Запрос("ВЫБРАТЬ ПЕРВЫЕ 1 Ссылка, Дата ИЗ Документ.БезТабличныхЧастей ГДЕ НЕ Проведен И НЕ ПометкаУдаления");
Выб = Запрос.Выполнить().Выбрать(); Выб.Следующий();
// записывается большой набор записей регистра, что приводит к эскалации
// аналогично, проблема возникнет при очистке большого набора
// эскалация блокировки на СУБД MSSQL возникнет при записи от 5000 строк в одном наборе
// эскалация на управляемых блокировках в данном случае возникнет при записи от 100 тыс. строк в одном наборе
// 
// Решения:
// 
// 1. Разбивать запись набора на части меньше 5000 строк
// 2. Отключить эскалацию СУБД флагом трассировки Т1224 (может повлиять на быстродействие)
// 3. Использовать поглощение управляемых блокировок

НачатьТранзакцию();
	
	// РегистрНакопления.Остаточный 
	Набор = РегистрыНакопления.Остаточный.СоздатьНаборЗаписей();
	Набор.Отбор.Регистратор.Установить(Выб.Ссылка);
	
	Для Инд = 1 По 100000 Цикл
		Стр = Набор.Добавить(); 
		Стр.Регистратор = Выб.Ссылка; 
		Стр.Период = Выб.Дата; 
		Стр.Склад = Справочники.Склады.Оптовый;
		Стр.НомерЯчейки = Инд; 
		Стр.Количество = 1;
	КонецЦикла;	
	
	Набор.Записать(Ложь); 
	
	Предупреждение("Записали набор РегистрНакопления.Остаточный");
	
ОтменитьТранзакцию();
