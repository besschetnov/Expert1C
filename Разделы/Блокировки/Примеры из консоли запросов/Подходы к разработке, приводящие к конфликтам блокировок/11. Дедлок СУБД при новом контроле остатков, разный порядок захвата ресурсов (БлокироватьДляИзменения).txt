// дедлок воспроизводится в управляемом режиме блокировок в режиме совместимости с 8.2
// лучше очистить таблицу итогов, т.е. сделать truncate table [TrProf83]..[_AccumRgT171]
// закомментировать строку "Набор.БлокироватьДляИзменения = Истина;"
// в 8.3 дедлока или ожидания не будет, но и контроль остатков будет работать не корректно
Запрос = Новый Запрос("ВЫБРАТЬ ПЕРВЫЕ 2 Ссылка, Дата ИЗ Документ.БезТабличныхЧастей ГДЕ НЕ Проведен И НЕ ПометкаУдаления");
ТаблицаЗапроса = Запрос.Выполнить().Выгрузить();

НачатьТранзакцию();

	Док = ТаблицаЗапроса[0].Ссылка;	// во втором окне выбрать вторую запись в таблице
	Период = ТаблицаЗапроса[0].Дата; 
	
	// 1. запись набора
	Набор = РегистрыНакопления.ПустойРегистр.СоздатьНаборЗаписей();
	Набор.Отбор.Регистратор.Установить(Док);
	Стр = Набор.Добавить();
	Стр.ВидДвижения = ВидДвиженияНакопления.Расход;
	Стр.Период = Период; Стр.Регистратор = Док; Стр.Количество = 1;
	Стр.Товар = Справочники.Товары.Смартфон;	
	//Набор.БлокироватьДляИзменения = Истина;
	Набор.Записать();
	Предупреждение("Записали набор");
	
	// 2. чтение остатков  - не списали ли в минус
	Запрос = Новый Запрос("
	|ВЫБРАТЬ 
	|	Товар, КоличествоОстаток
	|ИЗ
	|	РегистрНакопления.ПустойРегистр.Остатки(, Товар = &Товар)  
	|ГДЕ КоличествоОстаток < 0");
	
	Запрос.Параметры.Вставить("Товар", Справочники.Товары.Смартфон);
	Выб = Запрос.Выполнить().Выбрать();
	Пока Выб.Следующий() Цикл
		Отказ = истина;// 3. если нашли минусовые остатки, ругаемся
	КонецЦикла;
	Предупреждение("Прочитали остатки");
	
ОтменитьТранзакцию(); 