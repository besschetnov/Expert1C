// простой пример, демонстрирующий обмен документами без избыточных блокировок при выгрузке изменений
ОсновнойУзел = ПланыОбмена.Документы.НайтиПоКоду("Филиал");
ВыгруженныеДанные = ПланыОбмена.Документы.НайтиПоКоду("Выгружено");

ЗаписьСообщения = ПланыОбмена.СоздатьЗаписьСообщения();
Запись = Новый ЗаписьXML; Запись.ОткрытьФайл("C:\Work\ТестовоеСообщение.xml");
ЗаписьСообщения.НачатьЗапись(Запись, ОсновнойУзел);

ТекстЗапроса = "";
Для Каждого Элемент Из Метаданные.ПланыОбмена.Документы.Состав Цикл
	Если Метаданные.Документы.Содержит(Элемент.Метаданные) Тогда 
		ТекстЗапроса = ТекстЗапроса + ?(ТекстЗапроса="", "", " ОБЪЕДИНИТЬ ВСЕ") + Символы.ПС + 
		"ВЫБРАТЬ Ссылка ИЗ Документ."+Элемент.Метаданные.Имя+".Изменения"; 
	КонецЕсли;
КонецЦикла;

ЗапросВыборкиИзменений = Новый Запрос(ТекстЗапроса); ЭлементыФормы.ТекстЗапроса.УстановитьТекст(ТекстЗапроса); // для демонстрации результата
Выб = ЗапросВыборкиИзменений.Выполнить().Выбрать();

Пока Выб.Следующий() Цикл
	
	НачатьТранзакцию();
	
	Объект = Выб.Ссылка.ПолучитьОбъект();
	// удаляем регистрацию изменений с основного узла обмена
	ПланыОбмена.УдалитьРегистрациюИзменений(ОсновнойУзел, Объект);
	// регистрируем изменения на буферном узле, 
	// чтобы при необходимости повторить отправку тех же данных
	ПланыОбмена.ЗарегистрироватьИзменения(ВыгруженныеДанные, Объект);
	
	ЗафиксироватьТранзакцию();
	
	ЗаписатьXML(Запись, Объект); // запись в сообщение обмена

КонецЦикла;
