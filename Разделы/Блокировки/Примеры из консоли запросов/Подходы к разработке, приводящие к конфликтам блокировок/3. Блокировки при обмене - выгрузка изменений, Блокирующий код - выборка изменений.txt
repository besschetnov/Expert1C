
Узел = ПланыОбмена.Документы.НайтиПоКоду("Филиал");

ЗаписьСообщения = ПланыОбмена.СоздатьЗаписьСообщения();
Запись = Новый ЗаписьXML;
Запись.ОткрытьФайл("C:\Work\ТестовоеСообщение.xml");
ЗаписьСообщения.НачатьЗапись(Запись, Узел);

Предупреждение("Начало выборки изменений для сообщения № "+ЗаписьСообщения.НомерСообщения);

// причина блокировок: метод ВыбратьИзменения
// метод не только читает данные из таблиц регистрации изменений, но и записывает в таблицы регистрации номер сообщения
// номер сообщения проставляется для изменений, у которых номер сообщения Null, т.е. изменение ни разу не было выгружено
// запись номера сообщения выполняется в транзакции для всех изменений по каждому виду метаданных
//
// Пример: выбрали 1000 изменений для Документ1 = в одной транзакции заблокировали 1000 ссылок Документ1
Выб = ПланыОбмена.ВыбратьИзменения(Узел, ЗаписьСообщения.НомерСообщения);

Предупреждение("Окончание выборки изменений для сообщения № "+ЗаписьСообщения.НомерСообщения);

Пока Выб.Следующий() Цикл
    Объект = Выб.Получить();
    ЗаписатьXML(Запись, Объект);
КонецЦикла;

ЗаписьСообщения.ЗакончитьЗапись();
Запись.Закрыть();
