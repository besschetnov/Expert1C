Запрос = Новый Запрос("ВЫБРАТЬ ПЕРВЫЕ 1 Регистратор ИЗ РегистрНакопления.Остаточный");
Выб = Запрос.Выполнить().Выбрать(); Выб.Следующий();
// при переходе из авто в упр режим блокировок нужно явно блокировать данные,
// которые сначала читаются, затем пишутся
// в авто режиме получим дедлок, если не используем опцию ДЛЯ ИЗМЕНЕНИЯ
НачатьТранзакцию();

	// 1. чтение остатков (S)
	Запрос = Новый Запрос("
	|ВЫБРАТЬ
	|	Товар, КоличествоОстаток
	|ИЗ
	|	РегистрНакопления.Остаточный.Остатки(, Товар = &Товар)
	//|ДЛЯ ИЗМЕНЕНИЯ РегистрНакопления.Остаточный.Остатки
	|"); // ДЛЯ ИЗМЕНЕНИЯ - вместо S теперь U блокировка, таким образом преобразуем дедлок в ожидание
	
	Запрос.Параметры.Вставить("Товар", Справочники.Товары.Смартфон);
	РезультатЗапроса = Запрос.Выполнить().Выбрать();
	
	Предупреждение("Прочитаны остатки по товару");

	// 2. любой другой код
	// ......
	
	// 3. списание остатков
	Набор = РегистрыНакопления.Остаточный.СоздатьНаборЗаписей(); // (X)
	Набор.Отбор.Регистратор.Установить(Выб.Регистратор);
	// ..... заполнение измерений и ресурсов
	Набор.Записать();
	Предупреждение("Записан набор записей");
		
ОтменитьТранзакцию();

	//Блокир = Новый БлокировкаДанных; 
	//ЭлементБлокировки = Блокир.Добавить("РегистрНакопления.Остаточный"); 
	//ЭлементБлокировки.УстановитьЗначение("Товар", Справочники.Товары.Смартфон);
	//ЭлементБлокировки.Режим = РежимБлокировкиДанных.Исключительный;
	//Блокир.Заблокировать(); 
