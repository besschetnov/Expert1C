
-- Создаем временную таблицу для сохранения списка регистраторов и номеров строк регистра
INSERT INTO #tt7 WITH(TABLOCK) (Регистратор,
                                Регистратор,
                                НомерСтроки)
SELECT T1.RecorderTRef,
       T1.RecorderRRef,
       T1.LineNo_
FROM
  (SELECT DISTINCT T2.Регистратор AS RecorderTRef,
                   T2.Регистратор AS RecorderRRef,
                   T2.НомерСтроки AS LineNo_
   FROM РегистрБухгалтерии.бит_Дополнительный_1 T2
   INNER JOIN РегистрБухгалтерии.бит_Дополнительный_1.Субконто T3 ON T3.Регистратор = T2.Регистратор
   AND T3.Регистратор = T2.Регистратор
   AND T3.НомерСтроки = T2.НомерСтроки
   AND T3.Период = T2.Период
   AND T3._Correspond = &P1
   AND T3.Период >= &P2
   AND T3.Период <= &P3
   WHERE (((T2.ОбластьДанныхОсновныеДанные = &P4))
          AND (T3.ОбластьДанныхОсновныеДанные = &P5))
     AND (((T2.СчетКт = &P6)
           AND (T2.абс_Проект = &P7)
           AND (T3.Значение_TYPE = "0x08"
                AND T3.Значение_RTRef = "0x0000015E"
                AND T3.Значение = &P8)
           AND (T3.Значение_TYPE = "0x08"
                AND T3.Значение_RTRef = "0x0000015E"))
          AND T2.Период >= &P9
          AND T2.Период <= &P10)) T1
		  
	P6 = "90.3"   ПланСчетов.бит_Дополнительный_1
	P7 = "Проект ГО"   Справочник.абс_ОсновныеПроекты
	P8 = "Курсовая разница"   Справочник.абс_ВидыДоходовРасходов

		  

-- Переносим порцию данных (1000 строк) по регистраторам из предыдущей таблицы
INSERT INTO #tt8 WITH(TABLOCK) (_RecorderTRef,
                                _RecorderRRef,
                                _LineNo)
SELECT T1.RecorderTRef,
       T1.RecorderRRef,
       T1.LineNo_
FROM
  (SELECT TOP 1000 T2._RecorderTRef AS RecorderTRef,
              T2._RecorderRRef AS RecorderRRef,
              T2._LineNo AS LineNo_
   FROM #tt7 T2
   ORDER BY T2._RecorderTRef,
            T2._RecorderRRef,
            T2._LineNo) T1
			
-- Получаем данные по порции регистраторов из основной таблицы
INSERT INTO #tt9 WITH(TABLOCK) (НомерСтроки,
                                Регистратор,
                                Регистратор,
                                Организация,
                                СчетДт,
                                СчетКт,
                                абс_Проект,
                                абс_Классификатор,
                                СуммаРегл)
SELECT T2.НомерСтроки,
       T2.Регистратор,
       T2.Регистратор,
       T2.Организация,
       T2.СчетДт,
       T2.СчетКт,
       T2.абс_Проект,
       T2.абс_Классификатор,
       T2.СуммаРегл
FROM #tt8 T1
INNER JOIN РегистрБухгалтерии.бит_Дополнительный_1 T2 ON T1.Регистратор = T2.Регистратор
AND T1.Регистратор = T2.Регистратор
AND T1.НомерСтроки = T2.НомерСтроки
WHERE (T2.ОбластьДанныхОсновныеДанные = &P1)


-- Получаем данные по порции регистраторов из таблицы значений субконто
INSERT INTO #tt10 WITH(TABLOCK) (Регистратор,
                                 Регистратор,
                                 НомерСтроки,
                                 Вид,
                                 Значение_TYPE,
                                 Значение_RTRef,
                                 Значение,
                                 _Correspond,
                                 _AccEdKindLineNo)
SELECT T2.Регистратор,
       T2.Регистратор,
       T2.НомерСтроки,
       T2.Вид,
       T2.Значение_TYPE,
       T2.Значение_RTRef,
       T2.Значение,
       T2._Correspond,
       T3.НомерСтроки
FROM #tt9 T1
INNER JOIN РегистрБухгалтерии.бит_Дополнительный_1.Субконто T2 ON T1.Регистратор = T2.Регистратор
AND T1.Регистратор = T2.Регистратор
AND T1.НомерСтроки = T2.НомерСтроки
INNER JOIN ПланСчетов.бит_Дополнительный_1.ВидыСубконто T3 ON CASE
                                           WHEN T2._Correspond = &P1 THEN T1._AccountDtRRef
                                           ELSE T1._AccountCtRRef
                                       END = T3.Ссылка
AND T2.Вид = T3.ВидСубконто
WHERE ((T2.ОбластьДанныхОсновныеДанные = &P2))
  AND (T3.ОбластьДанныхОсновныеДанные = &P3)





